<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafeteria Bestell-API</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Globale Styles */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #050505; /* Dunkler Hintergrund */
            margin: 0;
            padding: 0;
            color: #ffffff; /* Weißer Text */
            transition: background-color 0.3s ease;
        }

        h1 {
            text-align: center;
            margin-top: 50px;
            font-size: 2.5rem;
            color: #94c120; /* Grüner Farbton */
            font-weight: 500;
        }

        h2 {
            font-size: 1.6rem;
            margin-bottom: 15px;
            color: #ffffff; /* Weiß für den Titel */
        }

        p {
            font-size: 1rem;
            color: #bbbbbb; /* Heller Text */
            text-align: center;
        }

        .container {
            background: #ffffff; /* Weißer Hintergrund */
            border-radius: 10px;
            padding: 25px;
            margin: 20px auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Formularelemente */
        input, button {
            width: 100%;
            padding: 14px;
            margin-bottom: 20px;
            border: 1px solid #dddddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.3s ease, transform 0.3s ease;
        }

        input:focus, button:focus {
            outline: none;
            border-color: #94c120; /* Grüner Fokus */
        }

        input:focus {
            transform: scale(1.02);
        }

        button {
            background-color: #94c120; /* Grüner Button */
            color: white;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        button:hover {
            background-color: #7a9c16; /* Dunklerer Grünton bei Hover */
            transform: scale(1.05);
        }

        /* Fehlerhinweise */
        .message {
            font-size: 1rem;
            color: red;
            margin-bottom: 10px;
            text-align: center;
        }

        .success-message {
            color: #94c120; /* Grüner Erfolgstext */
        }

        /* Logout Button */
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: auto;
            padding: 14px 20px;
            background-color: #94c120;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .logout-btn:hover {
            background-color: #7a9c16;
            transform: scale(1.05);
        }

        /* Auth-Formular */
        .auth-container {
            display: none;
        }

        .auth-container.active {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }

            .container {
                margin: 15px;
                padding: 20px;
            }

            .logout-btn {
                padding: 10px 14px;
                font-size: 0.9rem;
                top: 10px;
                right: 10px;
            }

            input, button {
                padding: 12px;
            }
        }
    </style>
</head>
<body>

    <h1>Cafeteria Bestell-API</h1>

    <div class="container auth-container" id="login-container">
        <h2>Login</h2>
        <div id="login-message" class="message"></div> <!-- Fehlernachricht für Login -->
        <input type="email" id="login-username" placeholder="Benutzername (E-Mail)">
        <input type="password" id="login-password" placeholder="Passwort">
        <button onclick="loginUser()">Anmelden</button>
        <p>Noch keinen Account? <a href="javascript:void(0)" onclick="showRegisterForm()">Hier registrieren</a></p>
    </div>

    <div class="container auth-container" id="register-container">
        <h2>Registrierung</h2>
        <div id="register-message" class="message"></div> <!-- Fehlernachricht für Registrierung -->
        <input type="email" id="reg-username" placeholder="Benutzername (E-Mail)">
        <input type="password" id="reg-password" placeholder="Passwort (min. 8 Zeichen)">
        <button onclick="registerUser()">Registrieren</button>
        <p>Bereits ein Account? <a href="javascript:void(0)" onclick="showLoginForm()">Hier anmelden</a></p>
    </div>

    <div class="container" id="order-container" style="display:none;">
        <button class="logout-btn" onclick="logoutUser()">Abmelden</button>
        <h2>3. Bestellung erstellen</h2>
        <input type="text" id="order-dish" value="Pizza Salami" placeholder="Gericht">
        <input type="number" id="order-qty" value="1" min="1" placeholder="Menge">
        <button onclick="createOrder()">Bestellung absenden</button>
        <div id="order-notification" style="color: #94c120; font-size: 1.2rem; margin-top: 20px;"></div> <!-- Benachrichtigung -->
    </div>

<script>
    const API_BASE = 'http://localhost/cafeteria-api/api_handler.php';
    let accessToken = localStorage.getItem('accessToken') || null;

    const loginMessage = document.getElementById('login-message');
    const registerMessage = document.getElementById('register-message');
    const loginContainer = document.getElementById('login-container');
    const registerContainer = document.getElementById('register-container');
    const orderContainer = document.getElementById('order-container');
    const orderNotification = document.getElementById('order-notification');

    // --- Anzeige ändern (Login/Register) ---
    function showLoginForm() {
        registerContainer.classList.remove('active');
        loginContainer.classList.add('active');
        loginMessage.textContent = ''; // Leeren bei Anzeige
    }

    function showRegisterForm() {
        loginContainer.classList.remove('active');
        registerContainer.classList.add('active');
        registerMessage.textContent = ''; // Leeren bei Anzeige
    }

    function showOrderPage() {
        loginContainer.style.display = 'none';
        registerContainer.style.display = 'none';
        orderContainer.style.display = 'block';
    }

    // --- API HANDLER ---
    async function registerUser() {
        const username = document.getElementById('reg-username').value;
        const password = document.getElementById('reg-password').value;

        const result = await sendRequest('register', 'POST', { username, password });
        if (result) {
            registerMessage.textContent = 'Registrierung erfolgreich! Bitte jetzt anmelden.';
            registerMessage.classList.add('success-message');
            showLoginForm(); // Nach der Registrierung zurück zum Login
        } else {
            registerMessage.textContent = 'Registrierung fehlgeschlagen. Bitte versuche es später erneut.';
            registerMessage.classList.remove('success-message');
        }
    }

    async function loginUser() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;

        const result = await sendRequest('login', 'POST', { username, password });
        if (result && result.accessToken) {
            accessToken = result.accessToken;
            localStorage.setItem('accessToken', accessToken);
            showOrderPage();
            loginMessage.textContent = 'Login erfolgreich!';
            loginMessage.classList.add('success-message');
        } else {
            loginMessage.textContent = 'Falscher Benutzername oder Passwort.';
            loginMessage.classList.remove('success-message');
        }
    }

    async function createOrder() {
        if (!accessToken) {
            alert('Fehler: Bitte zuerst anmelden (Token fehlt)!');
            return;
        }

        const dish = document.getElementById('order-dish').value;
        const quantity = parseInt(document.getElementById('order-qty').value, 10);

        const result = await sendRequest('bestellung', 'POST', { gericht: dish, menge: quantity }, true);
        if (result) {
            const orderCode = result.orderCode.toString().padStart(5, '0'); // Sicherstellen, dass der Code 5-stellig ist
            orderNotification.textContent = `Bestellung erfolgreich! Ihr Bestellcode ist: ${orderCode}`;
        }
    }

    function logoutUser() {
        accessToken = null;
        localStorage.removeItem('accessToken');
        location.reload(); // Seite neu laden nach Logout
    }

    // Utility Funktion für API Requests
    async function sendRequest(route, method = 'GET', body = null, needsAuth = false) {
        const url = `${API_BASE}?route=${route}`;
        const headers = { 'Content-Type': 'application/json' };

        if (needsAuth && accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
        }

        const options = { method, headers, body: body ? JSON.stringify(body) : null };

        try {
            const response = await fetch(url, options);
            const data = await response.json();

            if (!response.ok) {
                const errorMsg = `[${response.status} ${response.statusText}] API Fehler: ${data.error || 'Unbekannt'}`;
                return null;
            }

            return data;

        } catch (error) {
            alert(`Netzwerkfehler: ${error.message}`);
            return null;a
        }
    }

    // Initiale Anzeige
    if (accessToken) {
        showOrderPage();
    } else {
        showLoginForm();
    }
</script>

</body>
</html>
